-- Liquidate Tests

Test "Supply OMG, Mint VAI, OMG price crashes, Liquidate VAI"
    NewComptrollerWithVAIController price:1.0
    NewVToken ZRX vZRX
    NewVToken BAT vBAT
    Give vBAT 10e18 BAT -- Faucet some bat to borrow
    Support vZRX collateralFactor:0.5
    Support vBAT collateralFactor:0.5
    Prep Geoff Some ZRX vZRX
    Mint Geoff 100e18 vZRX
    EnterMarkets Geoff vZRX
    Borrow Geoff 1e18 vBAT
	Assert Equal (vToken vBAT BorrowBalance Geoff) (Exactly 1e18)
    Assert Equal (Bep20 BAT TokenBalance Geoff) (Exactly 1e18)
    Assert Equal (Bep20 BAT TokenBalance vBAT) (Exactly 9e18)
	MintVAI Geoff 1e18
	Assert Equal (Bep20 TokenBalance Geoff) 1e18 -- liquidator token balance should be reduced
	Assert Success
	-- Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- includes origination fee
	-- Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18") -- includes origination fee
	-- Assert Equal (TokenBalance Geoff BNB) (Exactly "1e18") -- does not include origination fee
	----
	---- BNB total supply unchanged
	--Assert Equal (BalanceSheetSupply BNB) (Exactly "2.0e18")
	----
	---- Crash OMG price and liquidate
	PriceOracle SetPrice vOMG 0.5
	LiquidateVAI Torrey Geoff 1e18 OMG
	Assert Success
	-- Assert Equal (BalanceSheetBorrow BNB) (Exactly "0.05e18") -- borrow was paid by liquidator
	-- Assert Equal (BorrowBalance Geoff BNB) (Exactly "0.05e18") -- target user should have liquidated amount closed on borrow
	-- Assert Equal (BalanceSheetSupply OMG) (Exactly "2.1e18")
	-- Assert Equal (SupplyBalance Geoff OMG) (Exactly "0e18") -- Collateral was the limit in this scenario
	-- Assert Equal (TokenBalance Torrey BNB) (Exactly "2.0e18") -- liquidator token balance should be reduced
	-- Assert Equal (TokenBalance Torrey OMG) (Exactly "0e18")
	-- Assert Equal (SupplyBalance Torrey OMG) (Exactly "2.1e18") -- Liquidator now has seized collateral

Test "Supply OMG, Borrow BNB, gain interest, OMG price crashes, Liquidate BNB"
	AddToken OMG
	SupportMarket OMG (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Geoff OMG "2.1e18"
	Faucet Geoff OMG "2.1e18"
	Supply Geoff OMG "2.1e18"
	Assert Success
	Assert Equal (SupplyBalance Geoff OMG) (Exactly "2.1e18")
	AddToken BNB
	SupportMarket BNB (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Torrey BNB "20.0e18"
	Faucet Torrey BNB "20.0e18"
	Supply Torrey BNB "10.0e18"
	Assert Equal (BalanceSheetSupply OMG) (Exactly "2.1e18")
	Assert Equal (TokenBalance Geoff BNB) (Exactly "0.0e18")
	EnterMarkets Geoff BNB
	Borrow Geoff BNB "1e18"
	Assert Success
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- includes origination fee
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18")
	Assert Equal (TokenBalance Geoff BNB) (Exactly "1e18") -- does not include origination fee
	FastForward 2 Blocks
	--
	-- Crash OMG price and liquidate
	SetMarketPriceOracle OMG (FixedPrice "0.8") -- Max liquidate at this price should be maxClose ~ 1.98947 E to meet collateral ratio
	Liquidate Torrey Geoff BNB "2e18" OMG
	Assert Failure INVALID_CLOSE_AMOUNT_REQUESTED LIQUIDATE_CLOSE_AMOUNT_TOO_HIGH
	Liquidate Torrey Geoff BNB "1.5e18" OMG
	Assert Success
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.125e18") -- (1.05) * ( 1 + 2 * .75 ) - 1.5
	Assert Equal (BalanceSheetSupply OMG) (Exactly "4.2e18")
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.125e18")
	Assert Equal (SupplyBalance Geoff OMG) (Exactly "2.23125e18") -- (2.1) * (1 + 2 * .5) - 1.96875 [amountSeize]
	Assert Equal (TokenBalance Torrey BNB) (Exactly "8.5e18")
	Assert Equal (SupplyBalance Torrey BNB) (Exactly "20e18") -- (10) * (1 + 2 * .5)
	Assert Equal (TokenBalance Torrey OMG) (Exactly "0e18")
	Assert Equal (SupplyBalance Torrey OMG) (Exactly "1.96875e18")

Test "Can't liquidate when contract is borrow asset is paused"
	AddToken OMG
	SupportMarket OMG (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Geoff OMG "2.1e18"
	Faucet Geoff OMG "2.1e18"
	Supply Geoff OMG "2.1e18"
	Assert Success
	Assert Equal (SupplyBalance Geoff OMG) (Exactly "2.1e18")
	AddToken BNB
	SupportMarket BNB (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Torrey BNB "5.0e18"
	Faucet Torrey BNB "5.0e18"
	Supply Torrey BNB "2.0e18"
	Assert Equal (BalanceSheetSupply OMG) (Exactly "2.1e18")
	Assert Equal (TokenBalance Geoff BNB) (Exactly "0.0e18")
	EnterMarkets Geoff BNB
	Borrow Geoff BNB "1e18"
	Assert Success
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- includes origination fee
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18") -- includes origination fee
	Assert Equal (TokenBalance Geoff BNB) (Exactly "1e18") -- does not include origination fee
	--
	-- BNB total supply unchanged
	Assert Equal (BalanceSheetSupply BNB) (Exactly "2.0e18")
	--
	-- Crash OMG price and liquidate
	SetMarketPriceOracle OMG (FixedPrice "0.5") -- Max liquidate at this price should be maxClose = 1E for all the supply
	PolicyHook BNB (SetProtocolPaused True)
	Liquidate Torrey Geoff BNB "1e18" OMG
	Assert Failure COMPTROLLER_REJECTION LIQUIDATE_POLICY_HOOK_ASSET_BORROW_REJECTION 1
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- unchanged
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18") -- unchanged

Test "Can't liquidate when contract is collateral asset is paused"
	AddToken OMG
	SupportMarket OMG (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Geoff OMG "2.1e18"
	Faucet Geoff OMG "2.1e18"
	Supply Geoff OMG "2.1e18"
	Assert Success
	Assert Equal (SupplyBalance Geoff OMG) (Exactly "2.1e18")
	AddToken BNB
	SupportMarket BNB (FixedPrice 1.0) (FixedRate 0.5 0.75) SimplePolicyHook
	Approve Torrey BNB "5.0e18"
	Faucet Torrey BNB "5.0e18"
	Supply Torrey BNB "2.0e18"
	Assert Equal (BalanceSheetSupply OMG) (Exactly "2.1e18")
	Assert Equal (TokenBalance Geoff BNB) (Exactly "0.0e18")
	EnterMarkets Geoff OMG BNB
	Borrow Geoff BNB "1e18"
	Assert Success
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- includes origination fee
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18") -- includes origination fee
	Assert Equal (TokenBalance Geoff BNB) (Exactly "1e18") -- does not include origination fee
	--
	-- BNB total supply unchanged
	Assert Equal (BalanceSheetSupply BNB) (Exactly "2.0e18")
	--
	-- Crash OMG price and liquidate
	SetMarketPriceOracle OMG (FixedPrice "0.5") -- Max liquidate at this price should be maxClose = 1E for all the supply
	PolicyHook OMG (SetProtocolPaused True)
	Liquidate Torrey Geoff BNB "1e18" OMG
	Assert Failure COMPTROLLER_REJECTION LIQUIDATE_POLICY_HOOK_ASSET_COLLATERAL_REJECTION 1
	Assert Equal (BalanceSheetBorrow BNB) (Exactly "1.05e18") -- unchanged
	Assert Equal (BorrowBalance Geoff BNB) (Exactly "1.05e18") -- unchanged
